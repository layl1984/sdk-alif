
def common_funcs

//def samples1 = [
//    'Echo_Client'     : 'zephyr/samples/net/sockets/echo_client',
//   'Echo_Server'     : 'zephyr/samples/net/sockets/echo_server',
//   'Test_Application': 'applications/testapp'
//]

def samples2 = ['le_audio/auracast','broadcast_mode_switch','unicast_sink','unicast_source']

def samples3 = ['le_central_batt','le_periph','le_periph_batt','le_periph_blinky']

def samples4 = ['le_periph_blps', 'le_periph_cgms','le_periph_cpps','le_periph_cscps']

def samples5 = ['le_periph_glps', 'le_periph_hello','le_periph_hr','le_periph_htpt']

def samples6 = [ 'le_periph_past','le_periph_plxp','le_periph_pm','le_periph_prxp','le_throughput']

def samples7 = ['le_periph_rscps','le_periph_ws','mesh_light_bulb','smp_svr']


//def bleStagesMap1 = samples1.collectEntries {
  //  ["${it}" : generate_ble_stage(it)]
//}

def bleStagesMap2 = samples2.collectEntries {
    ["${it}" : generate_ble_stage(it)]
}

def bleStagesMap3 = samples3.collectEntries {
    ["${it}" : generate_ble_stage(it)]
}

def bleStagesMap4 = samples4.collectEntries {
    ["${it}" : generate_ble_stage(it)]
}

def bleStagesMap5 = samples5.collectEntries {
    ["${it}" : generate_ble_stage(it)]
}
def bleStagesMap6 = samples6.collectEntries {
    ["${it}" : generate_ble_stage(it)]
}
def bleStagesMap7 = samples7.collectEntries {
    ["${it}" : generate_ble_stage(it)]
}

def generate_ble_stage(sample) {
    return {
        stage("Build ${sample} sample") {
            script {
                def testing = load 'ble_samples.groovy'
                testing.build_ble("samples/bluetooth/${sample}", "build-b1-${sample}", "alif_b1_dk/ab1c1f4m51820ph0/rtss_he");
            }
        }
    }
}



pipeline {
    agent any
    options {
        disableConcurrentBuilds abortPrevious: true
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('verify_checkpatch') {
            agent { label 'zas20' }
                options { skipDefaultCheckout() }
                steps {
                    script {
                        common_funcs = load 'automation/ble_samples.groovy'
                        common_funcs.verify_checkpatch();
                        }
                }

        }
        stage('verify_gitlint') {
            agent { label 'zas20' }
                options { skipDefaultCheckout() }
                steps {
                    script {
                        common_funcs = load 'automation/ble_samples.groovy'
                        common_funcs.verify_gitlint();
                        }
                }
        }
       // stage('BLE samples stage 1') {
         //       agent { label 'zas20' }
           //     options { skipDefaultCheckout() }
             //   steps {
               //     script {
                 //       parallel bleStagesMap1
                   //     }
                //    }
                  //  post {
                    //    success {
                      //      archiveArtifacts artifacts: '$sample.tar', fingerprint: true
                       // }
                 //   }
               // }
        stage('BLE samples stage 2') {
                agent { label 'zas20' }
                options { skipDefaultCheckout() }
                steps {
                    script {
                        parallel bleStagesMap1
                        }
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: '$sample.tar', fingerprint: true
                        }
                    }
                }
        stage('BLE samples stage 3') {
                agent { label 'zas20' }
                options { skipDefaultCheckout() }
                steps {
                    script {
                        parallel bleStagesMap1
                        }
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: '$sample.tar', fingerprint: true
                        }
                    }
                }
        stage('BLE samples stage 5') {
                agent { label 'zas20' }
                options { skipDefaultCheckout() }
                steps {
                    script {
                        parallel bleStagesMap1
                        }
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: '$sample.tar', fingerprint: true
                        }
                    }
                }
        stage('BLE samples stage 6') {
                agent { label 'zas20' }
                options { skipDefaultCheckout() }
                steps {
                    script {
                        parallel bleStagesMap1
                        }
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: '$sample.tar', fingerprint: true
                        }
                    }
                }
        stage('BLE samples stage 7') {
                agent { label 'zas20' }
                options { skipDefaultCheckout() }
                steps {
                    script {
                        parallel bleStagesMap1
                        }
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: '$sample.tar', fingerprint: true
                        }
                    }
                }

    }
}